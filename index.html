<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Control & OTA ESP8266</title>
<style> /* â€¦ stilurile rÄƒmÃ¢n la fel â€¦ */ </style>
</head>
<body>
  <h1>Control LED prin Blynk Cloud</h1>
  <button class="btn on"  onclick="toggleLED(1)">Aprinde LED</button>
  <button class="btn off" onclick="toggleLED(0)">Stinge LED</button>

  <div id="drop">
    <p><strong>UrcÄƒ firmware nou (.bin)</strong></p>
    <input id="ip" placeholder="IP placÄƒâ€¦" />
    <input id="file" type="file" accept=".bin" style="display:none">
    <button class="btn" onclick="file.click()">SelecteazÄƒ fiÈ™ier</button>
    <progress id="bar" hidden></progress>
  </div>

<script>
const token = "XYYoG-NWdMvYksGyqn_SFYzwYihNp_Cz";

/* ğŸŸ¢ 1. Auto-citeÈ™te IP-ul din V10 */
fetch(`https://blynk.cloud/external/api/get?token=${token}&V10`)
  .then(r => r.ok ? r.text() : "")
  .then(ip => { if(ip && ip !== "0") document.getElementById('ip').value = ip; });

/* 2. Aprinde/Stinge LED */
function toggleLED(v){
  fetch(`https://blynk.cloud/external/api/update?token=${token}&V0=${v}`)
      .then(r=>alert(r.ok? (v?"LED aprins":"LED stins"):"Eroare Blynk"));
}

/* 3. Upload OTA â€“ cod identic cu varianta precedentÄƒ */
const drop = document.getElementById('drop');
const bar  = document.getElementById('bar');
const file = document.getElementById('file');
['dragenter','dragover'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.add('drag');}));
['dragleave','drop'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.remove('drag');}));
drop.addEventListener('drop', ev=>{if(ev.dataTransfer.files.length) startUpload(ev.dataTransfer.files[0]);});
file.onchange=e=>startUpload(file.files[0]);

function startUpload(f){
  const ip = document.getElementById('ip').value.trim()||'esp8266.local';
  if(!f) return alert("SelecteazÄƒ .bin");
  const url=`http://${ip}/update`; const fd=new FormData(); fd.append('firmware',f);
  bar.hidden=false; bar.value=0;
  const xhr=new XMLHttpRequest();
  xhr.open('POST',url);
  xhr.upload.onprogress=e=> bar.value = e.lengthComputable ? e.loaded/e.total*100 : 0;
  xhr.onload=()=>alert(xhr.status===200?"Firmware trimis!":"Upload failed");
  xhr.send(fd);
}
</script>
</body>
</html>
